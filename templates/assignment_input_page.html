{% extends "base.html" %}

{% block title %}Assignment Input - Study Assistant{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-gradient text-white text-center py-4">
                    <h2 class="mb-0 text-light fw-bold text-shadow">
                        <i class="fas fa-file-alt me-2 text-warning"></i>
                        <span class="text-warning">Assignment Input</span>
                    </h2>
                    <div class="mt-3 p-2 bg-white bg-opacity-20 rounded-3 border border-white border-opacity-30">
                        <h5 class="mb-0 text-warning fw-bold">
                            <i class="fas fa-robot me-2"></i>
                            Create Your Custom Assignment with AI Assistant
                        </h5>
                    </div>
                </div>
                <div class="card-body p-5">
                    <form id="assignmentForm" enctype="multipart/form-data">
                        <!-- Assignment Name/Title -->
                        <div class="mb-4">
                            <label for="assignmentName" class="form-label fw-bold">
                                <i class="fas fa-heading me-2 text-primary"></i>
                                Assignment Name/Title *
                            </label>
                            <input type="text" class="form-control form-control-lg" id="assignmentName" 
                                   name="assignment_name" placeholder="Enter assignment title..." required>
                        </div>

                        <!-- Details/Requirements -->
                        <div class="mb-4">
                            <label for="details" class="form-label fw-bold">
                                <i class="fas fa-list-ul me-2 text-primary"></i>
                                Details or Requirements *
                            </label>
                            <textarea class="form-control" id="details" name="details" rows="6" 
                                      placeholder="Enter assignment details, requirements, questions, or instructions...&#10;• You can use bullet points&#10;• Include specific requirements&#10;• Add any special instructions" required></textarea>
                        </div>

                        <!-- Output Format -->
                        <div class="mb-4">
                            <label for="outputFormat" class="form-label fw-bold">
                                <i class="fas fa-file-export me-2 text-primary"></i>
                                Output Format
                            </label>
                            <select class="form-select form-select-lg" id="outputFormat" name="output_format">
                                <option value="Report">Report</option>
                                <option value="Essay">Essay</option>
                                <option value="Assignment">Assignment</option>
                                <option value="Research Paper">Research Paper</option>
                                <option value="Summary">Summary</option>
                                <option value="Analysis">Analysis</option>
                                <option value="Presentation">Presentation</option>
                            </select>
                        </div>

                        <!-- Word Count/Page Length -->
                        <div class="mb-4">
                            <label for="wordCount" class="form-label fw-bold">
                                <i class="fas fa-ruler me-2 text-primary"></i>
                                Word Count or Page Length (Optional)
                            </label>
                            <input type="text" class="form-control" id="wordCount" name="word_count" 
                                   placeholder="e.g., 1000 words, 5 pages, 2000-3000 words...">
                        </div>

                        <!-- File Upload -->
                        <div class="mb-4">
                            <label for="referenceFiles" class="form-label fw-bold">
                                <i class="fas fa-upload me-2 text-primary"></i>
                                Reference Files (Optional)
                            </label>
                            <input type="file" class="form-control" id="referenceFiles" name="reference_files" 
                                   multiple accept=".txt,.pdf,.docx,.doc">
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Supported formats: .txt, .pdf, .docx, .doc (Max 16MB per file)
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg py-3" id="submitBtn">
                                <i class="fas fa-magic me-2"></i>
                                Generate Assignment
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="card shadow-lg border-0 rounded-4 mt-4" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        Assignment Generated Successfully
                    </h4>
                </div>
                <div class="card-body">
                    <div id="assignmentResults"></div>
                    <div class="mt-3">
                        <button class="btn btn-outline-primary me-2" onclick="downloadResult()">
                            <i class="fas fa-download me-2"></i>Download
                        </button>
                        <button class="btn btn-outline-secondary" onclick="copyResult()">
                            <i class="fas fa-copy me-2"></i>Copy to Clipboard
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Section -->
            <div id="loadingSection" class="text-center mt-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Generating your assignment... Please wait.</p>
            </div>

            <!-- Error Section -->
            <div id="errorSection" class="alert alert-danger mt-4" style="display: none;">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage"></span>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('assignmentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const loadingSection = document.getElementById('loadingSection');
    const resultsSection = document.getElementById('resultsSection');
    const errorSection = document.getElementById('errorSection');
    
    // Hide previous results and errors
    resultsSection.style.display = 'none';
    errorSection.style.display = 'none';
    
    // Show loading
    loadingSection.style.display = 'block';
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    
    try {
        const formData = new FormData(this);
        
        const response = await fetch('/submit_assignment', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show results
            document.getElementById('assignmentResults').innerHTML = `
                <h5><strong>Assignment:</strong> ${data.assignment_name}</h5>
                <p><strong>Format:</strong> ${data.output_format}</p>
                ${data.uploaded_files.length > 0 ? `<p><strong>Reference Files:</strong> ${data.uploaded_files.join(', ')}</p>` : ''}
                <hr>
                <div class="assignment-content">${data.result.replace(/\n/g, '<br>')}</div>
            `;
            resultsSection.style.display = 'block';
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    } catch (error) {
        document.getElementById('errorMessage').textContent = error.message;
        errorSection.style.display = 'block';
    } finally {
        loadingSection.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate Assignment';
    }
});

function downloadResult() {
    const content = document.querySelector('.assignment-content').innerText;
    const assignmentName = document.querySelector('#assignmentResults h5').innerText;
    
    const element = document.createElement('a');
    const file = new Blob([content], {type: 'text/plain'});
    element.href = URL.createObjectURL(file);
    element.download = `${assignmentName.replace('Assignment: ', '')}.txt`;
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

function copyResult() {
    const content = document.querySelector('.assignment-content').innerText;
    navigator.clipboard.writeText(content).then(() => {
        alert('Content copied to clipboard!');
    });
}
</script>
{% endblock %}
